# 基于非负矩阵分解的osu!mania谱面推荐

## 一、数据处理与特征工程

### 1.1 数据来源与采集方式

#### 1.1.1 数据来源
本项目的数据来源于 osu! 官方提供的 OAuth2 API 接口，主要包括：
- 全球玩家排行榜（Rankings API）
- 玩家基本信息（Users API）
- 玩家 Best Performance（BP）成绩记录（Scores API）
研究对象为 osu!mania 模式（4K Variant）玩家
官方api的网址：https://osu.ppy.sh/api/v2/

#### 1.1.2 玩家候选集构建
为保证样本的代表性与数据质量，采用 “全球排行榜 + 国家分布约束”的分层抽样策略：
- 首先抓取 全球排行榜 Top10000 玩家
- 统计 Top10000 玩家中的国家分布情况
- 按各国家在 Top10000 中所占比例，计算目标玩家数量配额
在各国家排行榜中进一步抽取玩家，构建候选玩家集合
最终目标采集玩家总数设定为 10,000 人。

#### 1.1.3 玩家质量筛选标准
在候选玩家中，进一步对玩家进行质量过滤，确保其数据具有建模价值：
- 玩家总 pp ≥ 2000
- 玩家历史游玩次数 ≥ 50
- 玩家 BP 记录数量 ≥ 10
未满足上述条件的玩家将被剔除。


#### 1.1.4 成绩数据采集
对于通过筛选的玩家，抓取其 Best Performance（BP）成绩记录，每名玩家最多采集：
- 100 条 BP 成绩
每条成绩记录包含以下核心字段：
- 谱面 ID（beatmap_id）
- 谱面集 ID（beatmapset_id）
- pp 值
- 准确率
- 最大连击
- 使用模组
- 成绩时间等

#### 1.1.5 并发与限速策略（工程实现）
为提高采集效率并遵守 API 调用限制，系统采用如下工程策略：
- 使用 ThreadPoolExecutor 实现 多线程并发请求
- 最大并发线程数：8
- 请求间隔：0.1 秒
- OAuth2 Token 自动刷新机制
- 使用 生产者–消费者模型 异步写入数据库

#### 1.1.6 数据存储结构
采集的数据存储于本地 SQLite 数据库，主要包括两张表：
- users：存储玩家基础信息与统计指标
- user_scores：存储玩家 BP 成绩及对应谱面信息
数据库采用 WAL 模式以支持并发写入。

**1.2.1 低质量游玩记录过滤**
- 剔除pp值过低的游玩记录（pp ≤ 2000）
- 目的：排除无效或偶然性游玩数据，保留玩家真实实力表现

**1.2.2 低频谱面过滤**
- 剔除游玩次数少于10次的谱面
- 目的：确保谱面具有足够的样本量以供模型学习其潜在特征

**1.2.3 筛选后数据概况**
- 有效玩家数量：6028名
- 有效谱面数量：3502张
- 有效游玩记录数量：约90万条

### 1.3 数据矩阵构建
- 构建玩家-谱面交互矩阵X，维度为4467×1950
- 矩阵元素X[i,j]表示第i名玩家在第j张谱面上获得的pp值
- 缺失值处理：玩家未游玩的谱面对应矩阵位置填充为0

### 1.4 训练测试集分割
采用留一法进行数据集分割：
- 对于每张谱面，随机选择一条玩家游玩记录作为测试样本
- 其余所有记录作为训练数据
- 确保测试集覆盖所有谱面类型，评估模型泛化能力

## 二、模型构造

### 2.1 算法选择：非负矩阵分解（NMF）
选择NMF算法的理由：
1. **可解释性**：NMF产生的隐因子具有非负特性，可解释为"玩家技能向量"和"谱面难度向量"
2. **适用性**：适合处理非负值的玩家-谱面交互矩阵
3. **降维能力**：将高维稀疏矩阵分解为低维稠密表示

### 2.2 模型参数配置
模型初始化参数如下：
- 隐因子数量（n_components）：128
- 随机种子（random_state）：42（确保结果可复现）
- 最大迭代次数（max_iter）：500
- 正则化参数（alpha_W）：0.01
- L1正则化比例（l1_ratio）：0.1

参数选择依据：
1. 隐因子数量128：通过初步实验，在模型复杂度和表达能力间取得平衡
2. 正则化设置：防止过拟合，提升模型泛化能力
3. 迭代次数500：确保模型充分收敛

### 2.3 模型训练过程
- 输入：训练集玩家-谱面矩阵
- 学习目标：分解矩阵为玩家特征矩阵W和谱面特征矩阵H
- 约束条件：W和H的所有元素保持非负
- 损失函数：最小化原始矩阵与重构矩阵的Frobenius范数

## 三、模型评估

### 3.1 评估指标
采用以下两个回归任务常用指标：

**3.1.1 平均绝对误差（MAE）**
- 计算预测pp值与真实pp值之差的绝对值的平均数
- 优点：直观反映预测误差的平均大小
- 单位：pp值单位

**3.1.2 均方根误差（RMSE）**
- 计算预测pp值与真实pp值之差的平方和的平均数的平方根
- 优点：对大误差给予更高惩罚，反映预测稳定性

### 3.2 评估方法
- 在测试集上评估模型性能
- 测试集规模：1,950条记录（每谱面一条）
- 评估流程：
  1. 使用训练好的模型对测试集中玩家-谱面对进行pp值预测
  2. 计算预测值与实际值的差异
  3. 汇总计算MAE和RMSE指标

### 3.3 评估结果分析
（此处需填入实际评估结果，以下为示例格式）
- MAE：X.XX pp
- RMSE：Y.YY pp

结果解读：
1. MAE值表示模型预测平均误差范围
2. RMSE值反映预测误差的分布情况
3. 对比玩家pp值范围（通常0-1000+），评估模型相对准确性

## 四、预测与推荐系统

### 4.1 系统输入
- 输入数据：玩家UID
- 系统操作：
  1. 通过osu! API自动获取该玩家的BP列表
  2. 提取玩家在已知谱面库（1,950张谱面）上的pp记录
  3. 构建该玩家的特征向量

### 4.2 预测过程
1. **玩家特征提取**：基于已有游玩记录，通过模型推断玩家在128维隐空间的特征向量
2. **全谱面预测**：计算玩家特征向量与所有谱面特征向量的点积，得到玩家在所有谱面上的预测pp值
3. **结果筛选**：排除玩家已有游玩记录的谱面

### 4.3 推荐输出
- 输出内容：推荐谱面ID及预测pp值
- 排序方式：按预测pp值降序排列
- 推荐数量：前10个最高预测pp值的谱面
- 输出格式：
  ```
  推荐谱面ID：[ID1, ID2, ..., ID10]
  预测pp值：[pp1, pp2, ..., pp10]
  ```

### 4.4 系统特点
1. **个性化推荐**：基于玩家历史表现，推荐适合其技能水平的谱面
2. **冷启动处理**：对新玩家（在谱面库中记录较少）仍可提供合理推荐
3. **可解释性**：推荐理由透明（基于预测pp值高低）
4. **实用性**：推荐玩家可能擅长但未尝试的谱面，帮助玩家发现提升空间

## 五、总结与展望
本项目构建了一个基于NMF的osu!mania谱面推荐系统，通过数据清洗、特征工程和模型优化，实现了对玩家谱面表现的准确预测。系统能够为玩家个性化推荐适合其技能水平的未游玩谱面，有助于提升游戏体验和技能发展。

未来改进方向：
1. 引入更多玩家特征（如游玩时间、准确率等）
2. 考虑谱面元信息（歌曲风格、难度等级等）
3. 实现实时更新和增量学习
4. 扩展推荐多样性，避免过度集中于高pp谱面